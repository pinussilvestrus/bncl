<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="bpmnViewer(bpmn)">
    <h4>BPMN 2.0 XML output: </h4>
    <div class="row">
        <button
                class="waves-effect waves-dark btn blue-grey lighten-5 black-text"
                id="downloadBpmn"
                onclick="createAndOpenFile()"
                download="process.bpmn">
            Download as BPMN-file
        </button>
        <button
                class="waves-effect waves-dark btn blue-grey lighten-5 black-text"
                id="downloadWithUI"
                onclick="createAndOpenFileWithLayout()"
                download="process.bpmn">
            Download as BPMN-file with Layout
        </button>
    </div>
    <pre>
        <code id="xml" class="xml">...

        </code>
    </pre>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function () {
            var xml = [[${bpmn}]];

            if (xml != "") {
                $('html, body').animate({
                                            scrollTop: $("#xml").offset().top - 55
                                        }, 1200);
            }

            xml = addPrefix(xml);

            var xml_formatted = formatXML(xml);
            xml_escaped =
                    xml_formatted.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                            .replace(/ /g, '&nbsp;').replace(/\n/g, '<br />');

            var mydiv = document.getElementById('xml');

            mydiv.innerHTML = xml_escaped;
        });

        function addPrefix(xml) {
            xml = xml.replaceAllJustFirst("<+([a-z])", "<bpmn:");
            xml = xml.replaceAll("</", "</bpmn:");

            // add additional xml-namespaces
            var additionalNS = ' xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"'
                               + ' xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" ';
            var xmlDefinitions = "bpmn:definitions";

            xml = xml.substring(0, xml.indexOf(xmlDefinitions) + xmlDefinitions.length)
                  + additionalNS
                  + xml.substring(xml.indexOf(xmlDefinitions) + xmlDefinitions.length + 1);

            return xml;
        }

        function createAndOpenFile() {
            var bpmn = [[${bpmn}]];
            bpmn = addPrefix(bpmn);
            download(bpmn, "process.bpmn", "text/xml");
        }

        function createAndOpenFileWithLayout() {
            var bpmn = [[${bpmn}]];
            bpmn = addPrefix(bpmn);
            autoLayoutFromApi(bpmn);
            //download(bpmn, "process.bpmn", "text/xml");
        }

        /*]]>*/
    </script>
</div>
</body>
</html>